<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <title>Visualizer</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>
    </head>
    <body>
        <script src="js/three.js"></script>
        <script src="js/OrbitControls.js"></script>
        <script src="js/jquery-3.1.0.min.js"></script>
        <script>
            var show_axes = true;

            
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
            // If I don't move it, I cannot pan
            camera.position.z = 3;

            //var raycaster = new THREE.Raycaster();

            var renderer = new THREE.WebGLRenderer({ 
                alpha: true,
                // antialias: true // much slower!
                });
            // white bg
            renderer.setClearColor( 0xffffff, 0);
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );

            var bz_material = new THREE.MeshBasicMaterial(
            {
                color: 0xff3333,
                opacity: 0.7,
                transparent: true,
                //side: THREE.DoubleSide,
            });

            var edge_material = new THREE.MeshBasicMaterial(
            {
                color: 0x000000,
                opacity: 1.,
                transparent: false,
            });

            // strings to update
            var to_update = [];


            $( document ).ready(function() {
                $.getJSON("data/cF1_inv.json", function(jsondata) {
                special_points = jsondata['kpoints'];
                b1 = jsondata['b1'];
                b2 = jsondata['b2'];
                b3 = jsondata['b3'];

                max_b_length = Math.sqrt(Math.max(
                    Math.pow(b1[0],2) + Math.pow(b1[1],2) + Math.pow(b1[2],2),
                    Math.pow(b2[0],2) + Math.pow(b2[1],2) + Math.pow(b2[2],2),
                    Math.pow(b3[0],2) + Math.pow(b3[1],2) + Math.pow(b3[2],2)));

                var axeslength = max_b_length * 1.5;
                camera.position.z = max_b_length * 3;

                data = jsondata['faces_data'];
                for (var label in special_points) {
                    pos = special_points[label];

                    radius = 0.03 * max_b_length;

                    var sphgeometry = new THREE.SphereGeometry( radius, 16, 16 );
                    var sphmaterial = new THREE.MeshBasicMaterial( {color: 0x66FF66} );
                    var sphere = new THREE.Mesh( sphgeometry, sphmaterial );
                    sphere.translateX(pos[0]);
                    sphere.translateY(pos[1]);
                    sphere.translateZ(pos[2]);
                    scene.add(sphere);

                    // Label
                    var textdiv = document.createElement('div');
                    textdiv.style.position = 'absolute';
                    textdiv.style.fontFamily = "'Helvetica Neue', Helvetica, Arial, sans-serif";
                    //textdiv.style.zIndex = 1;    // if you still don't see the label, try uncommenting this
                    textdiv.style.width = 100;
                    textdiv.style.height = 100;
                    textdiv.style.backgroundColor = "transparent";

                    // prettify label
                    // Underscores
                    label = label.replace(/_(.)/gi,function (match, p1, offset, string) {
                        return '<sub>'+p1+'</sub>';
                    });
                    // Gamma
                    label = label.replace(/GAMMA/gi,'&Gamma;');


                    textdiv.innerHTML = label;
                    // out of view at the beginning
                    textdiv.style.top = -100 + 'px';
                    textdiv.style.left = -100 + 'px';
                    document.body.appendChild(textdiv);

                    to_update.push([
                        new THREE.Vector3(pos[0], pos[1], pos[2]), 
                        textdiv]);
                }

                if (show_axes) {
                    // AXES
                    //var dir = new THREE.Vector3( 1, 0, 0 );
                    [[new THREE.Vector3( 1, 0, 0 ), '<span style="font-style: italic">x</span>'],
                     [new THREE.Vector3( 0, 1, 0 ), '<span style="font-style: italic">y</span>'],
                     [new THREE.Vector3( 0, 0, 1 ), '<span style="font-style: italic">z</span>']].forEach(
                        function (data) {
                            dir = data[0];
                            label = data[1];

                            // Arrow
                            var origin = new THREE.Vector3( 0, 0, 0 );
                            var hex = 0x555555;
                            var arrow = new THREE.ArrowHelper(
                                dir, 
                                origin,
                                axeslength,
                                hex,
                                headLength=axeslength/10.,
                                headwidth=axeslength/20.);
                            //arrowX.line.material.linewidth = 2;
                            scene.add( arrow );                

                            // Label
                            var textdiv = document.createElement('div');
                            textdiv.style.position = 'absolute';
                            textdiv.style.fontFamily = "'Helvetica Neue', Helvetica, Arial, sans-serif";
                            //text2.style.zIndex = 1;    // if you still don't see the label, try uncommenting this
                            textdiv.style.color = "#555555";
                            textdiv.style.width = 100;
                            textdiv.style.height = 100;
                            //text2.style.backgroundColor = "blue";
                            textdiv.innerHTML = label;
                            // out of view at the beginning
                            textdiv.style.top = -100 + 'px';
                            textdiv.style.left = -100 + 'px';
                            document.body.appendChild(textdiv);

                            pos = dir.clone();
                            pos.sub(origin);
                            pos.multiplyScalar(axeslength);
                            to_update.push([pos, textdiv]);

                    });
                }

                // B vectors
                //var dir = new THREE.Vector3( 1, 0, 0 );
                [[b1, '<span style="font-weight: bold">b</span><sub>1</sub>'],
                 [b2, '<span style="font-weight: bold">b</span><sub>2</sub>'],
                 [b3, '<span style="font-weight: bold">b</span><sub>3</sub>']
                 ].forEach(
                    function (data) {
                        b = data[0];
                        label = data[1];

                        b_length = Math.sqrt(Math.pow(b[0],2) + Math.pow(b[1],2) + Math.pow(b[2],2));

                        dir = new THREE.Vector3(
                            b[0]/b_length,
                            b[1]/b_length,
                            b[2]/b_length);

                        // Arrow
                        var origin = new THREE.Vector3( 0, 0, 0 );
                        var hex = 0x000000;
                        var arrow = new THREE.ArrowHelper(
                            dir, 
                            origin,
                            length=b_length,
                            hex=hex,
                            headLength=b_length/10.,
                            headwidth=b_length/20.);
                        //arrowX.line.material.linewidth = 2;
                        scene.add( arrow );                

                        // Label
                        var textdiv = document.createElement('div');
                        textdiv.style.position = 'absolute';
                        textdiv.style.fontFamily = "'Helvetica Neue', Helvetica, Arial, sans-serif";
                        //text2.style.zIndex = 1;    // if you still don't see the label, try uncommenting this
                        //textdiv.style.color = "#555555";
                        textdiv.style.width = 100;
                        textdiv.style.height = 100;
                        //text2.style.backgroundColor = "blue";
                        textdiv.innerHTML = label;
                        // out of view at the beginning
                        textdiv.style.top = -100 + 'px';
                        textdiv.style.left = -100 + 'px';
                        document.body.appendChild(textdiv);

                        pos = dir.clone();
                        pos.sub(origin);
                        pos.multiplyScalar(b_length);
                        to_update.push([pos, textdiv]);

                });


                // Load BZ
                var brillouinzone = new THREE.Geometry();
                data['triangles_vertices'].forEach(function(vertex) {
                    brillouinzone.vertices.push(
                        new THREE.Vector3(vertex[0], vertex[1], vertex[2]));
                }); 
                data['triangles'].forEach(function(triangle) {
                    brillouinzone.faces.push(
                        new THREE.Face3(triangle[0], triangle[1], triangle[2]));
                });
                var bz_mesh = new THREE.Mesh(brillouinzone, bz_material);
                // Create BZ edges
                edges = new THREE.EdgesHelper( bz_mesh, 0x00ff00 );
                edges.material = edge_material;
                edges.material.linewidth = 2;
                // Plot BZ and edges
                scene.add(bz_mesh);
                scene.add(edges);
                }).fail(function( jqxhr, textStatus, error ) {
                        var err = textStatus + ", " + error;
                        console.log( "Request Failed: " + err );
                    });
            });

            function toScreenPosition(vector3D, camera)
            {
                var widthHalf = 0.5*renderer.context.canvas.width;
                var heightHalf = 0.5*renderer.context.canvas.height;

                vector2D = vector3D.clone().project(camera);

                vector2D.x = ( vector2D.x * widthHalf ) + widthHalf;
                vector2D.y = - ( vector2D.y * heightHalf ) + heightHalf;

                return { 
                    left: vector2D.x,
                    top: vector2D.y
                };

            };

            // render now!
            function render() { 
                requestAnimationFrame( render ); 
                renderer.render( scene, camera ); 
                

                to_update.forEach(function(data) {
                    pos = data[0];
                    text = data[1];
                    pos2d = toScreenPosition(pos,camera);
                    text.style.top = pos2d.top + 'px';
                    text.style.left = pos2d.left + 'px';
                });
            }

            controls = new THREE.OrbitControls( camera, renderer.domElement );
            //controls.addEventListener( 'change', render ); // add this only if there is no animation loop (requestAnimationFrame)
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.enableZoom = true;

            // render loop
            render();

        </script>
    </body>
</html>

