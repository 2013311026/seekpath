<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8>
    <title>Visualizer</title>
    <style>
    body {
        margin: 0; 
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none;   /* Chrome/Safari/Opera */
        -khtml-user-select: none;    /* Konqueror */
        -moz-user-select: none;      /* Firefox */
        -ms-user-select: none;       /* Internet Explorer/Edge */
        user-select: none;           /* Non-prefixed version, currently
                                        not supported by any browser */
    }
    html {
      overflow: hidden;
      background-color: #fff;
  }
  canvas { /* For ThreeJS */
    width: 100%; 
    height: 100% 
  }
  #canvas3d {
    background-color: #fff;
    width: 350px;
    height: 350px;
    border: 1px solid black;
    margin: 0px;
    padding: 0px;
    position: relative; /* Must be relative for clipping */
    top: 50px;
    left: 20px;
    overflow: hidden;
}
#combobox {
    top: 10px;
    left: 20px;
    position: fixed;
}
#info {
    top: 10px;
    left: 300px;
    position: fixed;
}
</style>
<script src="js/three.js"></script>
<script src="js/OrbitControls.js"></script>
<script src="js/jquery-3.1.0.min.js"></script>        
</head>
<body>



    <div id='canvas3d'></div><div id='info'></div>
    <select id='combobox' onchange='reload_all()'>
    <!--<option value='aP2_inv'>aP2 [with inversion]</option>
    <option value='aP3_inv'>aP3 [with inversion]</option>-->
    <option value='cF1_inv'>cF1 [with inversion]</option>
    <option value='cF2_inv'>cF2 [with inversion]</option>
    <option value='cI1_inv'>cI1 [with inversion]</option>
    <option value='cP1_inv'>cP1 [with inversion]</option>
    <option value='cP2_inv'>cP2 [with inversion]</option>
    <option value='hP1_inv'>hP1 [with inversion]</option>
    <option value='hP2_inv'>hP2 [with inversion]</option>
    <option value='hR1_inv'>hR1 [with inversion]</option>
    <option value='hR2_inv'>hR2 [with inversion]</option>
    <option value='mC1_inv'>mC1 [with inversion]</option>
    <option value='mC2_inv'>mC2 [with inversion]</option>
    <option value='mC3_inv'>mC3 [with inversion]</option>
    <option value='mP1_inv'>mP1 [with inversion]</option>
    <option value='oA1_inv'>oA1 [with inversion]</option>
    <option value='oA2_inv'>oA2 [with inversion]</option>
    <option value='oC1_inv'>oC1 [with inversion]</option>
    <option value='oC2_inv'>oC2 [with inversion]</option>
    <option value='oF1_inv'>oF1 [with inversion]</option>
    <option value='oF2_inv'>oF2 [with inversion]</option>
    <option value='oF3_inv'>oF3 [with inversion]</option>
    <option value='oI1_inv'>oI1 [with inversion]</option>
    <option value='oI2_inv'>oI2 [with inversion]</option>
    <option value='oI3_inv'>oI3 [with inversion]</option>
    <option value='oP1_inv'>oP1 [with inversion]</option>
    <option value='tI1_inv'>tI1 [with inversion]</option>
    <option value='tI2_inv'>tI2 [with inversion]</option>
    <option value='tP1_inv'>tP1 [with inversion]</option>
    <!--<option value='aP2_noinv'>aP2 [no inversion]</option>
    <option value='aP3_noinv'>aP3 [no inversion]</option>-->
    <option value='cF1_noinv'>cF1 [no inversion]</option>
    <option value='cF2_noinv'>cF2 [no inversion]</option>
    <option value='cI1_noinv'>cI1 [no inversion]</option>
    <option value='cP1_noinv'>cP1 [no inversion]</option>
    <option value='cP2_noinv'>cP2 [no inversion]</option>
    <option value='hP1_noinv'>hP1 [no inversion]</option>
    <option value='hP2_noinv'>hP2 [no inversion]</option>
    <option value='hR1_noinv'>hR1 [no inversion]</option>
    <option value='hR2_noinv'>hR2 [no inversion]</option>
    <option value='mC1_noinv'>mC1 [no inversion]</option>
    <option value='mC2_noinv'>mC2 [no inversion]</option>
    <option value='mC3_noinv'>mC3 [no inversion]</option>
    <option value='mP1_noinv'>mP1 [no inversion]</option>
    <option value='oA1_noinv'>oA1 [no inversion]</option>
    <option value='oA2_noinv'>oA2 [no inversion]</option>
    <option value='oC1_noinv'>oC1 [no inversion]</option>
    <option value='oC2_noinv'>oC2 [no inversion]</option>
    <option value='oF1_noinv'>oF1 [no inversion]</option>
    <option value='oF2_noinv'>oF2 [no inversion]</option>
    <option value='oF3_noinv'>oF3 [no inversion]</option>
    <option value='oI1_noinv'>oI1 [no inversion]</option>
    <option value='oI2_noinv'>oI2 [no inversion]</option>
    <option value='oI3_noinv'>oI3 [no inversion]</option>
    <option value='oP1_noinv'>oP1 [no inversion]</option>
    <option value='tI1_noinv'>tI1 [no inversion]</option>
    <option value='tI2_noinv'>tI2 [no inversion]</option>
    <option value='tP1_noinv'>tP1 [no inversion]</option>
  </select>

  <script>
  var show_axes = true;

  var canvas3d = document.getElementById('canvas3d');
    // document.body.appendChild( canvas3d );

    canvas3d_width = canvas3d.offsetWidth;
    canvas3d_height = canvas3d.offsetHeight;

    var scene = new THREE.Scene();
    var camera = new THREE.PerspectiveCamera( 45, canvas3d_width / canvas3d_height, 0.01, 10 );
    // If I don't move it, I cannot pan
    camera.position.z = 3;

    //var raycaster = new THREE.Raycaster();

    var renderer = new THREE.WebGLRenderer({ 
        alpha: true,
        // antialias: true // much slower!
    });
    // white bg
    renderer.setClearColor( 0xffffff, 0);
    //renderer.setClearColor( 0xcccccc, 0);

    renderer.setSize( canvas3d_width, canvas3d_height );
    //document.body.appendChild( renderer.domElement );
    canvas3d.appendChild( renderer.domElement );

    // strings to update
    var to_update = [];

    var bz_material = new THREE.MeshBasicMaterial(
    {
        color: 0xd53e4f,
        opacity: 0.7,
        transparent: true,
        //side: THREE.DoubleSide,
    });

    var edge_material = new THREE.MeshBasicMaterial(
    {
        color: 0x333333,
        opacity: 1.,
        transparent: false,
    });

    var line_material = new THREE.MeshBasicMaterial(
    {
        color: 0x045a8d,
        opacity: 1.,
        transparent: false,
    });

    var point_material = new THREE.MeshBasicMaterial(
    {
        color: 0x3288bd,
        opacity: 1.,
        transparent: false,
    });

    var reload_all = function() {
        combovalue = document.getElementById('combobox').value;
        newpath_to_load = "data/" + combovalue + ".json";
        document.getElementById('info').innerHTML = "Loading..."

        $.getJSON(newpath_to_load, function(jsondata) {

        document.getElementById('info').innerHTML = ""

        canvas3d.removeChild( renderer.domElement );
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera( 45, canvas3d_width / canvas3d_height, 0.01, 10 );
        // If I don't move it, I cannot pan
        camera.position.z = 3;

        //var raycaster = new THREE.Raycaster();

        renderer = new THREE.WebGLRenderer({ 
            alpha: true,
            // antialias: true // much slower!
        });
        // white bg
        renderer.setClearColor( 0xffffff, 0);
        //renderer.setClearColor( 0xcccccc, 0);

        renderer.setSize( canvas3d_width, canvas3d_height );
        //document.body.appendChild( renderer.domElement );
        canvas3d.appendChild( renderer.domElement );

        controls = new THREE.OrbitControls( camera, renderer.domElement );
        controls.addEventListener( 'change', render ); // add this only if there is no animation loop (requestAnimationFrame)
        // needed because we want to redraw only on change
        controls.enableDamping = true;
        controls.dampingFactor = 0.25;
        controls.enableZoom = true;


        ///
        // clear the old divs, and empty the to_update list
        to_update.forEach(function(elem) {
            canvas3d.removeChild(elem[1]);
        })
        to_update = [];
        
        /*// remove all old elements
        scene.children = [];*/

        special_points = jsondata['kpoints'];
        b1 = jsondata['b1'];
        b2 = jsondata['b2'];
        b3 = jsondata['b3'];

        max_b_length = Math.sqrt(Math.max(
            Math.pow(b1[0],2) + Math.pow(b1[1],2) + Math.pow(b1[2],2),
            Math.pow(b2[0],2) + Math.pow(b2[1],2) + Math.pow(b2[2],2),
            Math.pow(b3[0],2) + Math.pow(b3[1],2) + Math.pow(b3[2],2)));

        var axeslength = max_b_length * 1.5;
        camera.position.z = max_b_length * 3;

        data = jsondata['faces_data'];
        for (var label in special_points) {
            pos = special_points[label];

            radius = 0.02 * max_b_length;

            var sphere_geometry = new THREE.SphereGeometry(
                radius, 16, 16 );
            var sphere = new THREE.Mesh(
                sphere_geometry, point_material );
            sphere.translateX(pos[0]);
            sphere.translateY(pos[1]);
            sphere.translateZ(pos[2]);
            scene.add(sphere);

            // Label
            var textdiv = document.createElement('div');
            textdiv.style.position = 'absolute';
            textdiv.style.fontFamily = "'Helvetica Neue', Helvetica, Arial, sans-serif";
            //textdiv.style.zIndex = 1;    // if you still don't see the label, try uncommenting this
            textdiv.style.width = 100;
            textdiv.style.height = 100;
            textdiv.style.backgroundColor = "transparent";

            // prettify label
            // Underscores
            label = label.replace(/_(.)/gi,function (match, p1, offset, string) {
                return '<sub>'+p1+'</sub>';
            });
            // Gamma
            label = label.replace(/GAMMA/gi,'&Gamma;');


            textdiv.innerHTML = label;
            textdiv.style.userSelect = "none";
            textdiv.style.userSelect = "none";
            textdiv.style.webkitUserSelect = "none";
            textdiv.style.MozUserSelect = "none";
            textdiv.setAttribute("unselectable", "on");

            // out of view at the beginning
            textdiv.style.top = -100 + 'px';
            textdiv.style.left = -100 + 'px';
            canvas3d.appendChild(textdiv);

            to_update.push([
                new THREE.Vector3(pos[0], pos[1], pos[2]), 
                textdiv]);
        }


        if (show_axes) {
            // AXES
            //var dir = new THREE.Vector3( 1, 0, 0 );
            [[new THREE.Vector3( 1, 0, 0 ), '<span style="font-style: italic">x</span>'],
            [new THREE.Vector3( 0, 1, 0 ), '<span style="font-style: italic">y</span>'],
            [new THREE.Vector3( 0, 0, 1 ), '<span style="font-style: italic">z</span>']].forEach(
                function (data) {
                    dir = data[0];
                    label = data[1];

                    // Arrow
                    var origin = new THREE.Vector3( 0, 0, 0 );
                    var hex = 0x555555;
                    var arrow = new THREE.ArrowHelper(
                        dir, 
                        origin,
                        axeslength,
                        hex,
                        headLength=axeslength/10.,
                        headwidth=axeslength/20.);
                    //arrowX.line.material.linewidth = 2;
                    scene.add( arrow );                

                    // Label
                    var textdiv = document.createElement('div');
                    textdiv.style.position = 'absolute';
                    textdiv.style.fontFamily = "'Helvetica Neue', Helvetica, Arial, sans-serif";
                    //text2.style.zIndex = 1;    // if you still don't see the label, try uncommenting this
                    textdiv.style.color = "#555555";
                    textdiv.style.width = 100;
                    textdiv.style.height = 100;
                    //text2.style.backgroundColor = "blue";
                    textdiv.innerHTML = label;
                    // out of view at the beginning
                    textdiv.style.top = -100 + 'px';
                    textdiv.style.left = -100 + 'px';
                    textdiv.style.userSelect = "none";
                    textdiv.style.userSelect = "none";
                    textdiv.style.webkitUserSelect = "none";
                    textdiv.style.MozUserSelect = "none";
                    textdiv.setAttribute("unselectable", "on");

                    canvas3d.appendChild(textdiv);

                    pos = dir.clone();
                    pos.sub(origin);
                    pos.multiplyScalar(axeslength);
                    to_update.push([pos, textdiv]);

                });
        }

        // B vectors
        //var dir = new THREE.Vector3( 1, 0, 0 );
        [[b1, '<span style="font-weight: bold">b</span><sub>1</sub>'],
        [b2, '<span style="font-weight: bold">b</span><sub>2</sub>'],
        [b3, '<span style="font-weight: bold">b</span><sub>3</sub>']
        ].forEach(
            function (data) {
                b = data[0];
                label = data[1];

                b_length = Math.sqrt(Math.pow(b[0],2) + Math.pow(b[1],2) + Math.pow(b[2],2));

                dir = new THREE.Vector3(
                    b[0]/b_length,
                    b[1]/b_length,
                    b[2]/b_length);

                // Arrow
                var origin = new THREE.Vector3( 0, 0, 0 );
                var hex = 0x000000;
                var arrow = new THREE.ArrowHelper(
                    dir, 
                    origin,
                    length=b_length,
                    hex=hex,
                    headLength=b_length/10.,
                    headwidth=b_length/20.);
                //arrowX.line.material.linewidth = 2;
                scene.add( arrow );                

                // Label
                var textdiv = document.createElement('div');
                textdiv.style.position = 'absolute';
                textdiv.style.fontFamily = "'Helvetica Neue', Helvetica, Arial, sans-serif";
                //text2.style.zIndex = 1;    // if you still don't see the label, try uncommenting this
                //textdiv.style.color = "#555555";
                textdiv.style.width = 100;
                textdiv.style.height = 100;
                //text2.style.backgroundColor = "blue";
                textdiv.innerHTML = label;
                // out of view at the beginning
                textdiv.style.top = -100 + 'px';
                textdiv.style.left = -100 + 'px';
                textdiv.style.userSelect = "none";
                textdiv.style.userSelect = "none";
                textdiv.style.webkitUserSelect = "none";
                textdiv.style.MozUserSelect = "none";
                textdiv.setAttribute("unselectable", "on");
                canvas3d.appendChild(textdiv);

                pos = dir.clone();
                pos.sub(origin);
                pos.multiplyScalar(b_length);
                to_update.push([pos, textdiv]);

            });

        // Load BZ
        var brillouinzone = new THREE.Geometry();
        data['triangles_vertices'].forEach(function(vertex) {
            brillouinzone.vertices.push(
                new THREE.Vector3(vertex[0], vertex[1], vertex[2]));
        }); 
        data['triangles'].forEach(function(triangle) {
            brillouinzone.faces.push(
                new THREE.Face3(triangle[0], triangle[1], triangle[2]));
        });
        var bz_mesh = new THREE.Mesh(brillouinzone, bz_material);
        // Create BZ edges
        edges = new THREE.EdgesHelper( bz_mesh, 0x00ff00 );
        edges.material = edge_material;
        edges.material.linewidth = 2;
        // Plot BZ and edges
        scene.add(bz_mesh);
        scene.add(edges);


        // draw path
        path = jsondata['path'];
        path.forEach(function (linespec) {
            label1 = linespec[0];
            label2 = linespec[1];
            p1 = special_points[label1];
            p2 = special_points[label2];

            var geometry = new THREE.Geometry();
            geometry.vertices.push(
                new THREE.Vector3(p1[0], p1[1], p1[2]));
            geometry.vertices.push(
                new THREE.Vector3(p2[0], p2[1], p2[2]));
            var line = new THREE.Line(geometry, line_material);
            line.material.linewidth = 4;
            scene.add(line);
        });        

        camera.updateProjectionMatrix(); 
        render();

        }).fail(function( jqxhr, textStatus, error ) {
            var err = textStatus + ", " + error;
            console.log( "Request Failed: " + err );
            document.getElementById('info').innerHTML = "Request Failed: " + err;
        });
    }

$( document ).ready(function() {
    reload_all();
});


function toScreenPosition(vector3D, camera)
{
    var widthHalf = 0.5*renderer.context.canvas.width;
    var heightHalf = 0.5*renderer.context.canvas.height;

    vector2D = vector3D.clone().project(camera);

    vector2D.x = ( vector2D.x * widthHalf ) + widthHalf;
    vector2D.y = - ( vector2D.y * heightHalf ) + heightHalf;

    return { 
        left: vector2D.x,
        top: vector2D.y
    };

};

// render now!
function render() { 
    requestAnimationFrame( render ); 
    renderer.render( scene, camera ); 
    

    to_update.forEach(function(data) {
        pos = data[0];
        text = data[1];
        pos2d = toScreenPosition(pos,camera);
        text.style.top = pos2d.top + 'px';
        text.style.left = pos2d.left + 'px';
    });
}

// render loop - not needed if there are no animations
//render();

</script>
</body>
</html>

